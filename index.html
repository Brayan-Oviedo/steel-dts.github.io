<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="icon" type="image/png" href="./favicon.png?v=1">    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cuentas de Acero</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #111; color: white; font-family: sans-serif; touch-action: manipulation; }
        .input-big { font-size: 1.5rem; padding: 15px; width: 100%; border-radius: 12px; background: #222; border: 1px solid #444; color: white; text-align: center; }
        .input-small { font-size: 1rem; padding: 8px; width: 100%; border-radius: 8px; background: #222; border: 1px solid #444; color: #ccc; text-align: center; }
        .btn { padding: 15px; border-radius: 12px; font-weight: bold; width: 100%; text-align: center; cursor: pointer; transition: 0.2s; }
        .btn-gray { background-color: #333; color: white; border: 1px solid #444; }
        .btn-green { background-color: #22c55e; color: black; box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3); }
        .btn-blue { background-color: #2563eb; color: white; border-top: 1px solid #60a5fa; }
        .btn-orange { background-color: #f97316; color: white; border-top: 1px solid #fdba74; }
        .btn-yellow { background-color: #eab308; color: black; box-shadow: 0 4px 15px rgba(234, 179, 8, 0.3); }
        .btn-red { background-color: #ef4444; color: white; }
        .card { background: #1c1c1c; padding: 20px; border-radius: 16px; margin-bottom: 20px; border: 1px solid #333; }
        .progress-container { width: 100%; background-color: #333; border-radius: 10px; height: 25px; margin-top: 5px; overflow: hidden; position: relative; }
        .progress-bar { height: 100%; transition: width 0.5s; text-align: center; line-height: 25px; font-size: 12px; color: white; font-weight: bold; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
        .bar-rent { background-color: #ef4444; } 
        .bar-profit { background-color: #eab308; color: black; text-shadow: none; } 
        .badge { font-size: 0.70rem; padding: 4px 6px; border-radius: 6px; font-weight: bold; display: inline-block; white-space: nowrap; }
        .badge-blue { background-color: #1e3a8a; color: #93c5fd; border: 1px solid #1d4ed8; }
        .badge-green { background-color: #14532d; color: #86efac; border: 1px solid #15803d; }
        .badge-gray { background-color: #374151; color: #d1d5db; border: 1px solid #4b5563; }
        
        /* Modal de Importaci√≥n */
        #modalImport { background: rgba(0,0,0,0.85); backdrop-filter: blur(4px); }
    </style>
</head>
<body class="p-4 pb-40">

    <div class="max-w-xl mx-auto">

        <div class="card border-l-4 border-blue-600 shadow-xl" id="inicio">
            <h2 class="text-gray-400 text-xs font-bold uppercase mb-3 tracking-widest">Resumen del Mes</h2>
            <div class="flex justify-between text-sm mb-1">
                <span>üè† Arriendo ($2.5M)</span>
                <span id="txtRentPercent" class="font-bold text-gray-300">0%</span>
            </div>
            <div class="progress-container mb-4">
                <div id="barraArriendo" class="progress-bar bar-rent" style="width: 0%">Falta</div>
            </div>
            <div class="flex justify-between text-sm mb-1">
                <span>üí∞ Ganancia Extra</span>
                <span id="txtProfitTotal" class="text-yellow-400 font-bold">$0</span>
            </div>
            <div class="progress-container border border-yellow-900/50 bg-gray-900 mb-6">
                <div id="barraGanancia" class="progress-bar bar-profit" style="width: 0%"></div>
            </div>
            <div class="bg-blue-900/20 border border-blue-800 p-3 rounded-xl text-center shadow-inner">
                <div class="text-[10px] text-blue-300 uppercase tracking-widest mb-1">üë®‚Äçüè≠ Mi Sueldo Acumulado</div>
                <div id="txtTotalSueldo" class="text-3xl font-bold text-blue-100">$0</div>
            </div>
            <p class="text-[10px] text-gray-600 mt-3 text-center pt-2">(Ganancia Negocio: <span id="txtTotalNeto" class="text-gray-500">$0</span>)</p>
        </div>

        <div class="card shadow-lg">
            <h2 id="tituloEditor" class="text-xl font-bold mb-6 text-center text-white">üî® Cotizar Trabajo</h2>
            <label class="text-gray-400 text-xs uppercase font-bold block mb-2">1. Gasto en Materiales</label>
            <input type="number" id="inputMaterial" class="input-big mb-6 focus:border-blue-500 outline-none" placeholder="$0" oninput="calcular()">
            <div class="flex justify-between items-end mb-2">
                <label class="text-gray-400 text-xs uppercase font-bold">2. D√≠as de Trabajo</label>
                <div class="text-right">
                    <label class="text-[10px] text-blue-400 mr-1">Valor d√≠a:</label>
                    <input type="number" id="valorDia" value="150000" class="input-small w-24 bg-blue-900/10" oninput="calcular()">
                </div>
            </div>
            <div class="grid grid-cols-4 gap-2 mb-3">
                <button class="btn btn-gray py-3" onclick="setDias(1)">1</button>
                <button class="btn btn-gray py-3" onclick="setDias(2)">2</button>
                <button class="btn btn-gray py-3" onclick="setDias(3)">3</button>
                <button class="btn btn-gray py-3" onclick="setDias(5)">5</button>
            </div>
            <input type="number" id="inputDias" class="input-big mb-6" value="1" oninput="calcular()">
            <label class="text-gray-400 text-xs uppercase font-bold flex justify-between mb-2">
                <span>3. Margen Ganancia</span>
                <span id="lblMultiplicador" class="text-yellow-400 font-mono text-lg">80%</span>
            </label>
            <input type="range" id="rangeGanancia" min="1.1" max="2.5" step="0.05" value="1.8" class="w-full h-3 bg-gray-700 rounded-lg appearance-none cursor-pointer mb-8 accent-yellow-500" oninput="calcular()">
            <div class="bg-black p-5 rounded-xl text-center border border-gray-700 mb-6">
                <div class="text-gray-500 text-xs uppercase tracking-widest mb-1">Precio Final</div>
                <div id="txtPrecioFinal" class="text-5xl font-bold text-white mb-4">$0</div>
                <div class="flex justify-center flex-wrap gap-4 text-[10px] border-t border-gray-800 pt-3">
                    <div>üî© Mat: <span id="miniMaterial" class="text-gray-300">$0</span></div>
                    <div>üë®‚Äçüè≠ Sueldo: <span id="miniSueldo" class="text-blue-300">$0</span></div>
                    <div>üè¢ Negocio: <span id="miniGanancia" class="text-green-300">$0</span></div>
                </div>
            </div>
            <button id="btnGuardar" onclick="guardarTrabajo()" class="btn btn-green text-xl uppercase tracking-wider">üíæ Registrar Trabajo</button>
            <button id="btnCancelarEdicion" onclick="cancelarEdicion()" class="btn btn-gray text-xs mt-3 hidden italic">Cancelar Edici√≥n</button>
        </div>

        <div class="flex justify-between items-end mb-4 px-1">
            <h3 class="font-bold text-white text-lg tracking-tight">Historial</h3>
            <button onclick="borrarTodo()" class="text-[10px] text-red-500 hover:text-red-400 transition-colors border border-red-900 px-2 py-1 rounded">üóëÔ∏è BORRAR MES</button>
        </div>
        <div id="listaHistorial" class="space-y-3"></div>

        <div class="mt-8 mb-10 border-t border-gray-800 pt-6">
            <h4 class="text-center text-gray-500 text-[10px] uppercase tracking-widest mb-4">Copia de Seguridad</h4>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <button onclick="exportarExcel()" class="btn btn-blue flex items-center justify-center gap-2 text-sm">üìÑ Descargar Copia</button>
                <label class="btn btn-orange flex items-center justify-center gap-2 text-sm cursor-pointer">
                    üîÑ Restaurar Copia
                    <input type="file" id="fileImport" class="hidden" accept=".csv" onchange="leerArchivoParaModal(event)">
                </label>
            </div>
        </div>
    </div>

    <div id="modalImport" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-[#1c1c1c] w-full max-w-md rounded-2xl border border-gray-700 p-6 shadow-2xl">
            <h3 class="text-xl font-bold text-white mb-2">Restaurar Datos</h3>
            <p id="modalMsg" class="text-gray-400 text-sm mb-6">Se encontraron trabajos. ¬øQu√© deseas hacer?</p>
            
            <div class="flex flex-col gap-3">
                <button id="btnFusionar" class="btn btn-green py-3 text-sm">‚ûï FUSIONAR (Unir a los actuales)</button>
                <button id="btnSobreescribir" class="btn btn-red py-3 text-sm">‚ö†Ô∏è SOBREESCRIBIR (Reemplazar todo)</button>
                <button onclick="cerrarModal()" class="btn btn-gray py-3 text-sm">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        const META_ARRIENDO = 2500000;
        let trabajos = JSON.parse(localStorage.getItem('metalApp_v8_trabajos')) || []; 
        let editandoId = null;
        let registrosLeidosTemporales = []; // Almac√©n para el modal

        function setDias(n) { document.getElementById('inputDias').value = n; calcular(); }
        function formatoDinero(num) { return "$" + num.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, "."); }

        function calcular() {
            const material = parseFloat(document.getElementById('inputMaterial').value) || 0;
            const dias = parseFloat(document.getElementById('inputDias').value) || 0;
            const valorDia = parseFloat(document.getElementById('valorDia').value) || 0;
            const multiplicador = parseFloat(document.getElementById('rangeGanancia').value);
            const sueldo = dias * valorDia;
            const costoTotal = material + sueldo;
            const precioVenta = costoTotal * multiplicador;
            const gananciaNegocio = precioVenta - costoTotal;

            document.getElementById('lblMultiplicador').innerText = Math.round((multiplicador - 1) * 100) + "%";
            document.getElementById('txtPrecioFinal').innerText = formatoDinero(precioVenta);
            document.getElementById('miniMaterial').innerText = formatoDinero(material);
            document.getElementById('miniSueldo').innerText = formatoDinero(sueldo);
            document.getElementById('miniGanancia').innerText = formatoDinero(gananciaNegocio);
        }

        function guardarTrabajo() {
            const material = parseFloat(document.getElementById('inputMaterial').value) || 0;
            const dias = parseFloat(document.getElementById('inputDias').value) || 0;
            const valorDia = parseFloat(document.getElementById('valorDia').value) || 0;
            const multiplicador = parseFloat(document.getElementById('rangeGanancia').value);
            if(material === 0 && dias === 0) return alert("Ingresa datos primero");

            const sueldo = dias * valorDia;
            const costoTotal = material + sueldo;
            const precioVenta = costoTotal * multiplicador;
            const gananciaNegocio = precioVenta - costoTotal;

            if (editandoId !== null) {
                const index = trabajos.findIndex(t => t.id === editandoId);
                trabajos[index] = { ...trabajos[index], precio: precioVenta, material, sueldo, ganancia: gananciaNegocio, desc: `${dias}d trabajo` };
                alert("‚úÖ Actualizado");
                cancelarEdicion();
            } else {
                trabajos.unshift({
                    id: Date.now(), fecha: new Date().toLocaleDateString(),
                    precio: precioVenta, material, sueldo, ganancia: gananciaNegocio, desc: `${dias}d trabajo`
                });
                alert("‚úÖ Registrado");
            }
            localStorage.setItem('metalApp_v8_trabajos', JSON.stringify(trabajos));
            document.getElementById('inputMaterial').value = '';
            actualizarUI();
        }

        function editarTrabajo(id) {
            const t = trabajos.find(job => job.id === id);
            if (!t) return;
            editandoId = id;
            document.getElementById('inputMaterial').value = t.material;
            document.getElementById('inputDias').value = t.desc.replace('d trabajo', '').trim();
            document.getElementById('tituloEditor').innerText = "‚úèÔ∏è Editando Trabajo";
            document.getElementById('btnGuardar').innerText = "üîÑ ACTUALIZAR TRABAJO";
            document.getElementById('btnGuardar').classList.replace('btn-green', 'btn-yellow');
            document.getElementById('btnCancelarEdicion').classList.remove('hidden');
            window.scrollTo({ top: document.getElementById('inicio').offsetHeight, behavior: 'smooth' });
            calcular();
        }

        function cancelarEdicion() {
            editandoId = null;
            document.getElementById('inputMaterial').value = '';
            document.getElementById('inputDias').value = '1';
            document.getElementById('tituloEditor').innerText = "üî® Cotizar Trabajo";
            document.getElementById('btnGuardar').innerText = "üíæ Registrar Trabajo";
            document.getElementById('btnGuardar').classList.replace('btn-yellow', 'btn-green');
            document.getElementById('btnCancelarEdicion').classList.add('hidden');
            calcular();
        }

        function eliminarTrabajo(id) {
            if(confirm("¬øEst√°s seguro de eliminar este trabajo espec√≠fico?")) {
                trabajos = trabajos.filter(t => t.id !== id);
                localStorage.setItem('metalApp_v8_trabajos', JSON.stringify(trabajos));
                if (editandoId === id) cancelarEdicion();
                actualizarUI();
            }
        }

        function actualizarUI() {
            const lista = document.getElementById('listaHistorial');
            lista.innerHTML = trabajos.length === 0 ? '<div class="text-center text-gray-600 py-10 italic text-sm">Sin registros</div>' : '';
            let totalGanancia = 0; let totalSueldo = 0;
            trabajos.forEach(t => {
                totalGanancia += t.ganancia; totalSueldo += (t.sueldo || 0);
                lista.innerHTML += `
                    <div class="bg-gray-800 p-4 rounded-xl border border-gray-700 shadow-lg relative">
                        <div class="absolute top-4 right-4 flex gap-2">
                            <button onclick="eliminarTrabajo(${t.id})" class="text-red-500 text-xs border border-red-900 px-2 py-1 rounded">Eliminar</button>
                            <button onclick="editarTrabajo(${t.id})" class="text-yellow-500 text-xs border border-yellow-900 px-2 py-1 rounded">Editar</button>
                        </div>
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <div class="text-2xl font-bold text-white tracking-tight">${formatoDinero(t.precio)}</div>
                                <div class="text-[10px] text-gray-400 uppercase">${t.fecha} ‚Ä¢ ${t.desc}</div>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-1 border-t border-gray-700 pt-3">
                            <div class="badge badge-gray">üî© Material: ${formatoDinero(t.material)}</div>
                            <div class="badge badge-blue">üë®‚Äçüè≠ Sueldo: ${formatoDinero(t.sueldo)}</div>
                            <div class="badge badge-green">üè¢ Negocio: ${formatoDinero(t.ganancia)}</div>
                        </div>
                    </div>`;
            });
            document.getElementById('txtTotalNeto').innerText = formatoDinero(totalGanancia);
            document.getElementById('txtTotalSueldo').innerText = formatoDinero(totalSueldo);
            let porc = Math.min((totalGanancia / META_ARRIENDO) * 100, 100);
            const barraArr = document.getElementById('barraArriendo');
            barraArr.style.width = porc + "%";
            barraArr.innerText = porc < 100 ? Math.round(porc) + "%" : "PAGADO";
            barraArr.style.backgroundColor = porc < 100 ? "#ef4444" : "#22c55e";
            document.getElementById('txtRentPercent').innerText = porc < 100 ? Math.round(porc) + "%" : "‚úÖ";
            let extra = Math.max(totalGanancia - META_ARRIENDO, 0);
            document.getElementById('txtProfitTotal').innerText = formatoDinero(extra);
            const barraGan = document.getElementById('barraGanancia');
            barraGan.style.width = extra > 0 ? Math.min((extra / 10000000) * 100, 100) + "%" : "0%";
            barraGan.innerText = extra > 0 ? "ü§ë" : "";
        }

        function exportarExcel() {
            if(trabajos.length === 0) return alert("No hay datos");
            let csv = "\uFEFFFecha;Trabajo;Material;Sueldo;Ganancia;Total\n";
            trabajos.forEach(t => { 
                csv += `${t.fecha};${t.desc};${t.material};${t.sueldo};${t.ganancia};${t.precio}\n`; 
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `RESPALDO_ACERO_${new Date().toLocaleDateString().replace(/\//g,'-')}.csv`;
            link.click();
        }

        // --- L√ìGICA DE IMPORTACI√ìN CON MODAL ---
        function leerArchivoParaModal(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const lines = e.target.result.split("\n");
                registrosLeidosTemporales = [];
                
                for (let i = 1; i < lines.length; i++) {
                    const c = lines[i].split(";");
                    if (c.length < 6) continue;
                    
                    // Aseguramos que los n√∫meros se lean correctamente
                    registrosLeidosTemporales.push({
                        id: Date.now() - (i * 1000), 
                        fecha: c[0].replace("\uFEFF", ""), 
                        desc: c[1], 
                        material: parseFloat(c[2]), 
                        sueldo: parseFloat(c[3]), 
                        ganancia: parseFloat(c[4]), 
                        precio: parseFloat(c[5])
                    });
                }
                
                if (registrosLeidosTemporales.length > 0) {
                    abrirModal(registrosLeidosTemporales.length);
                } else {
                    alert("‚ùå El archivo no es v√°lido.");
                }
            };
            reader.readAsText(file);
            event.target.value = ''; 
        }

        function abrirModal(cantidad) {
            document.getElementById('modalMsg').innerText = `Se encontraron ${cantidad} registros. ¬øQu√© deseas hacer con el historial actual?`;
            document.getElementById('modalImport').classList.remove('hidden');
            
            // Acci√≥n FUSIONAR
            document.getElementById('btnFusionar').onclick = function() {
                trabajos = [...registrosLeidosTemporales, ...trabajos];
                finalizarImportacion(`‚úÖ Fusionados con √©xito.`);
            };

            // Acci√≥n SOBREESCRIBIR
            document.getElementById('btnSobreescribir').onclick = function() {
                if(confirm("‚ö†Ô∏è ¬øEST√ÅS SEGURO? Tus datos actuales se borrar√°n y quedar√°n los del archivo.")) {
                    trabajos = registrosLeidosTemporales;
                    finalizarImportacion("‚úÖ Historial reemplazado.");
                }
            };
        }

        function finalizarImportacion(msg) {
            localStorage.setItem('metalApp_v8_trabajos', JSON.stringify(trabajos));
            actualizarUI();
            cerrarModal();
            setTimeout(() => { alert(msg); }, 100);
        }

        function cerrarModal() {
            document.getElementById('modalImport').classList.add('hidden');
            registrosLeidosTemporales = [];
        }

        function borrarTodo() {
            if(confirm("¬øBorrar todo?") && confirm("¬øSeguro? Perder√°s los datos sin respaldo.")) {
                localStorage.removeItem('metalApp_v8_trabajos');
                trabajos = []; actualizarUI();
            }
        }
        
        actualizarUI();
    </script>
</body>
</html>