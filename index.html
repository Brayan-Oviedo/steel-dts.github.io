<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cuentas de Acero</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #111; color: white; font-family: sans-serif; touch-action: manipulation; }
        
        /* Inputs y Botones */
        .input-big { font-size: 1.5rem; padding: 15px; width: 100%; border-radius: 12px; background: #222; border: 1px solid #444; color: white; text-align: center; }
        .input-small { font-size: 1rem; padding: 8px; width: 100%; border-radius: 8px; background: #222; border: 1px solid #444; color: #ccc; text-align: center; }
        .btn { padding: 15px; border-radius: 12px; font-weight: bold; width: 100%; text-align: center; cursor: pointer; transition: 0.2s; }
        .btn-gray { background-color: #333; color: white; border: 1px solid #444; }
        .btn-green { background-color: #22c55e; color: black; box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3); }
        .btn-blue { background-color: #2563eb; color: white; border-top: 1px solid #60a5fa; }
        .btn-orange { background-color: #f97316; color: white; border-top: 1px solid #fdba74; }
        .card { background: #1c1c1c; padding: 20px; border-radius: 16px; margin-bottom: 20px; border: 1px solid #333; }
        
        /* Barras de Progreso */
        .progress-container { width: 100%; background-color: #333; border-radius: 10px; height: 25px; margin-top: 5px; overflow: hidden; position: relative; }
        .progress-bar { height: 100%; transition: width 0.5s; text-align: center; line-height: 25px; font-size: 12px; color: white; font-weight: bold; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
        .bar-rent { background-color: #ef4444; } 
        .bar-profit { background-color: #eab308; color: black; text-shadow: none; } 
        
        /* Badges */
        .badge { font-size: 0.70rem; padding: 4px 6px; border-radius: 6px; font-weight: bold; display: inline-block; white-space: nowrap; }
        .badge-blue { background-color: #1e3a8a; color: #93c5fd; border: 1px solid #1d4ed8; }
        .badge-green { background-color: #14532d; color: #86efac; border: 1px solid #15803d; }
        .badge-gray { background-color: #374151; color: #d1d5db; border: 1px solid #4b5563; }
    </style>
</head>
<body class="p-4 pb-32">

    <div class="card border-l-4 border-blue-600">
        <h2 class="text-gray-400 text-xs font-bold uppercase mb-3 tracking-widest">Resumen del Mes</h2>

        <div class="flex justify-between text-sm mb-1">
            <span>üè† Arriendo ($2.5M)</span>
            <span id="txtRentPercent" class="font-bold text-gray-300">0%</span>
        </div>
        <div class="progress-container mb-4">
            <div id="barraArriendo" class="progress-bar bar-rent" style="width: 0%">Falta</div>
        </div>

        <div class="flex justify-between text-sm mb-1">
            <span class="text-yellow-500">üí∞ Ganancia Extra (Ahorro)</span>
            <span id="txtProfitTotal" class="text-yellow-400 font-bold">$0</span>
        </div>
        <div class="progress-container border border-yellow-900/50 bg-gray-900 mb-6">
            <div id="barraGanancia" class="progress-bar bar-profit" style="width: 0%"></div>
        </div>

        <div class="bg-blue-900/20 border border-blue-800 p-3 rounded-xl text-center shadow-inner relative overflow-hidden">
            <div class="text-[10px] text-blue-300 uppercase tracking-widest mb-1">üë®‚Äçüè≠ Mi Sueldo Acumulado</div>
            <div id="txtTotalSueldo" class="text-3xl font-bold text-blue-100">$0</div>
        </div>
        
        <p class="text-[10px] text-gray-600 mt-3 text-center pt-2">
            (Ganancia Negocio: <span id="txtTotalNeto" class="text-gray-500">$0</span>)
        </p>
    </div>

    <div class="card">
        <h2 class="text-xl font-bold mb-6 text-center text-white">üî® Cotizar Trabajo</h2>
        
        <label class="text-gray-400 text-xs uppercase font-bold block mb-2">1. Gasto en Materiales</label>
        <input type="number" id="inputMaterial" class="input-big mb-6 focus:border-blue-500 outline-none" placeholder="$0" oninput="calcular()">

        <div class="flex justify-between items-end mb-2">
            <label class="text-gray-400 text-xs uppercase font-bold">2. D√≠as de Trabajo</label>
            <div class="text-right">
                <label class="text-[10px] text-blue-400 mr-1">Valor de mi d√≠a:</label>
                <input type="number" id="valorDia" value="150000" class="input-small w-28 text-blue-200 border-blue-900/50 bg-blue-900/20" oninput="calcular()">
            </div>
        </div>

        <div class="grid grid-cols-4 gap-2 mb-3">
            <button class="btn btn-gray py-3" onclick="setDias(1)">1</button>
            <button class="btn btn-gray py-3" onclick="setDias(2)">2</button>
            <button class="btn btn-gray py-3" onclick="setDias(3)">3</button>
            <button class="btn btn-gray py-3" onclick="setDias(5)">5</button>
        </div>
        <input type="number" id="inputDias" class="input-big mb-6" value="1" placeholder="D√≠as exactos" oninput="calcular()">

        <label class="text-gray-400 text-xs uppercase font-bold flex justify-between mb-2">
            <span>3. Margen Ganancia</span>
            <span id="lblMultiplicador" class="text-yellow-400 font-mono text-lg">80%</span>
        </label>
        <input type="range" id="rangeGanancia" min="1.1" max="2.5" step="0.05" value="1.8" class="w-full h-3 bg-gray-700 rounded-lg appearance-none cursor-pointer mb-8 accent-yellow-500" oninput="calcular()">

        <div class="bg-black p-5 rounded-xl text-center border border-gray-700 mb-6 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-gray-500 via-blue-500 to-green-500"></div>
            
            <div class="text-gray-500 text-xs uppercase tracking-widest mb-1">Precio Final al Cliente</div>
            <div id="txtPrecioFinal" class="text-5xl font-bold text-white mb-4 tracking-tight">$0</div>
            
            <div class="flex justify-center gap-4 text-xs border-t border-gray-800 pt-3">
                <div class="text-center">
                    <div class="text-gray-500 mb-1 font-bold">üî© Material</div>
                    <div id="miniMaterial" class="text-gray-300 font-mono">$0</div>
                </div>
                <div class="text-center border-l border-gray-800 pl-4">
                    <div class="text-blue-400 mb-1 font-bold">üë®‚Äçüè≠ Mi Sueldo</div>
                    <div id="miniSueldo" class="text-blue-300 font-mono">$0</div>
                </div>
                <div class="text-center border-l border-gray-800 pl-4">
                    <div class="text-green-400 mb-1 font-bold">üè¢ Negocio</div>
                    <div id="miniGanancia" class="text-green-300 font-mono">$0</div>
                </div>
            </div>
        </div>

        <button onclick="guardarTrabajo()" class="btn btn-green text-xl uppercase tracking-wider">üíæ Registrar Trabajo</button>
    </div>

    <div class="flex justify-between items-end mb-4 px-1 mt-8">
        <h3 class="font-bold text-white text-lg">Historial Reciente</h3>
        <button onclick="borrarTodo()" class="text-xs text-red-500 hover:text-red-400 transition-colors">üóëÔ∏è Borrar Todo</button>
    </div>
    
    <div id="listaHistorial" class="pb-4 space-y-3"></div>
    
    <div class="grid grid-cols-1 gap-3 mt-6 mb-10">
        <button onclick="exportarExcel()" class="btn btn-blue flex items-center justify-center gap-2 shadow-lg">
            üìÑ Guardar Copia (Descargar)
        </button>
        
        <label class="btn btn-orange flex items-center justify-center gap-2 shadow-lg cursor-pointer">
            üîÑ Restaurar Copia (Subir Archivo)
            <input type="file" id="fileImport" class="hidden" accept=".csv" onchange="importarExcel(event)">
        </label>
        <p class="text-[10px] text-gray-500 text-center uppercase tracking-tighter">Respalda siempre despu√©s de cada trabajo importante</p>
    </div>

    <script>
        const META_ARRIENDO = 2500000;
        // Llave de datos consistente
        let trabajos = JSON.parse(localStorage.getItem('metalApp_v8_trabajos')) || []; 

        function setDias(n) {
            document.getElementById('inputDias').value = n;
            calcular();
        }

        function formatoDinero(num) {
            return "$" + num.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }

        function calcular() {
            const material = parseFloat(document.getElementById('inputMaterial').value) || 0;
            const dias = parseFloat(document.getElementById('inputDias').value) || 0;
            const valorDia = parseFloat(document.getElementById('valorDia').value) || 0;
            const multiplicador = parseFloat(document.getElementById('rangeGanancia').value);

            const sueldo = dias * valorDia;
            const costoTotal = material + sueldo;
            const precioVenta = costoTotal * multiplicador;
            const gananciaNegocio = precioVenta - costoTotal;

            document.getElementById('lblMultiplicador').innerText = Math.round((multiplicador - 1) * 100) + "%";
            document.getElementById('txtPrecioFinal').innerText = formatoDinero(precioVenta);
            
            document.getElementById('miniMaterial').innerText = formatoDinero(material);
            document.getElementById('miniSueldo').innerText = formatoDinero(sueldo);
            document.getElementById('miniGanancia').innerText = formatoDinero(gananciaNegocio);
        }

        function guardarTrabajo() {
            const material = parseFloat(document.getElementById('inputMaterial').value) || 0;
            const dias = parseFloat(document.getElementById('inputDias').value) || 0;
            const valorDia = parseFloat(document.getElementById('valorDia').value) || 0;
            
            if(material === 0 && dias === 0) return alert("Ingresa datos primero");

            const multiplicador = parseFloat(document.getElementById('rangeGanancia').value);
            const sueldo = dias * valorDia;
            const costoTotal = material + sueldo;
            const precioVenta = costoTotal * multiplicador;
            const gananciaNegocio = precioVenta - costoTotal;

            const nuevoTrabajo = {
                id: Date.now(),
                fecha: new Date().toLocaleDateString(),
                precio: precioVenta,
                material: material,
                sueldo: sueldo,
                ganancia: gananciaNegocio,
                desc: `${dias}d trabajo`
            };

            trabajos.unshift(nuevoTrabajo);
            localStorage.setItem('metalApp_v8_trabajos', JSON.stringify(trabajos));
            
            document.getElementById('inputMaterial').value = '';
            document.getElementById('inputDias').value = '1';
            calcular();
            actualizarUI();
            alert("‚úÖ Trabajo registrado correctamente");
        }

        function actualizarUI() {
            const lista = document.getElementById('listaHistorial');
            if(trabajos.length === 0) {
                lista.innerHTML = '<div class="text-center text-gray-600 py-10 italic text-sm">No hay trabajos registrados a√∫n</div>';
            } else {
                lista.innerHTML = '';
            }

            let totalGananciaNegocio = 0;
            let totalSueldoAcumulado = 0;

            trabajos.forEach(t => {
                totalGananciaNegocio += t.ganancia;
                totalSueldoAcumulado += (t.sueldo || 0);
                
                const matDisplay = t.material ? formatoDinero(t.material) : '$0';
                const sueldoDisplay = t.sueldo ? formatoDinero(t.sueldo) : '$0';
                const gananciaDisplay = t.ganancia ? formatoDinero(t.ganancia) : '$0';

                lista.innerHTML += `
                    <div class="bg-gray-800 p-4 rounded-xl border border-gray-700 shadow-lg relative overflow-hidden">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <div class="text-2xl font-bold text-white tracking-tight">${formatoDinero(t.precio)}</div>
                                <div class="text-[10px] text-gray-400 uppercase tracking-wider">${t.fecha} ‚Ä¢ ${t.desc}</div>
                            </div>
                        </div>
                        <div class="flex justify-between gap-1 border-t border-gray-700 pt-3">
                            <div class="badge badge-gray">üî© Material: ${matDisplay}</div>
                            <div class="flex gap-1">
                                <div class="badge badge-blue">üë®‚Äçüè≠ Sueldo: ${sueldoDisplay}</div>
                                <div class="badge badge-green">üè¢ Negocio: ${gananciaDisplay}</div>
                            </div>
                        </div>
                    </div>
                `;
            });

            document.getElementById('txtTotalNeto').innerText = formatoDinero(totalGananciaNegocio);
            document.getElementById('txtTotalSueldo').innerText = formatoDinero(totalSueldoAcumulado);

            let abonoArriendo = Math.min(totalGananciaNegocio, META_ARRIENDO);
            let porcentajeArriendo = (abonoArriendo / META_ARRIENDO) * 100;
            const barraArr = document.getElementById('barraArriendo');
            barraArr.style.width = porcentajeArriendo + "%";
            
            if(porcentajeArriendo < 100) {
                barraArr.innerText = Math.round(porcentajeArriendo) + "%";
                barraArr.style.backgroundColor = "#ef4444"; 
                document.getElementById('txtRentPercent').innerText = Math.round(porcentajeArriendo) + "%";
                document.getElementById('txtRentPercent').style.color = "#ef4444";
            } else {
                barraArr.innerText = "¬°PAGADO!";
                barraArr.style.backgroundColor = "#22c55e"; 
                document.getElementById('txtRentPercent').innerText = "‚úÖ";
            }

            let gananciaLibre = Math.max(totalGananciaNegocio - META_ARRIENDO, 0);
            document.getElementById('txtProfitTotal').innerText = formatoDinero(gananciaLibre);
            
            const barraGan = document.getElementById('barraGanancia');
            if(gananciaLibre > 0) {
                 let porcentajeExtra = Math.min((gananciaLibre / 10000000) * 100, 100); 
                 barraGan.style.width = porcentajeExtra + "%";
                 barraGan.innerText = "ü§ë";
            } else {
                 barraGan.style.width = "0%";
                 barraGan.innerText = "";
            }
        }

        // --- EXPORTAR EXCEL ---
        function exportarExcel() {
            if(trabajos.length === 0) return alert("No hay datos para exportar a√∫n.");
            let csvContent = "\uFEFFFecha;Trabajo;Material;Sueldo;Ganancia;Total\n";
            trabajos.forEach(t => {
                csvContent += `${t.fecha};${t.desc};${t.material};${t.sueldo};${t.ganancia};${t.precio}\n`;
            });
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = `RESPALDO_ACERO_${new Date().toLocaleDateString().replace(/\//g,'-')}.csv`;
            link.click();
        }

        // --- IMPORTAR (PLAN DE CONTINGENCIA) ---
        function importarExcel(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const lines = content.split("\n");
                let nuevosTrabajos = [];

                for (let i = 1; i < lines.length; i++) {
                    const cols = lines[i].split(";");
                    if (cols.length >= 6) {
                        nuevosTrabajos.push({
                            id: Date.now() + i,
                            fecha: cols[0].replace("\uFEFF", ""),
                            desc: cols[1],
                            material: parseFloat(cols[2]),
                            sueldo: parseFloat(cols[3]),
                            ganancia: parseFloat(cols[4]),
                            precio: parseFloat(cols[5])
                        });
                    }
                }

                if (nuevosTrabajos.length > 0) {
                    if (confirm(`Se encontraron ${nuevosTrabajos.length} trabajos. ¬øQuieres reemplazar tu historial actual con esta copia?`)) {
                        trabajos = nuevosTrabajos;
                        localStorage.setItem('metalApp_v8_trabajos', JSON.stringify(trabajos));
                        actualizarUI();
                        alert("‚úÖ Historial restaurado con √©xito.");
                    }
                } else {
                    alert("‚ùå El archivo no parece ser una copia de seguridad v√°lida.");
                }
            };
            reader.readAsText(file);
        }

        function borrarTodo() {
            if(confirm("¬øEst√°s seguro de borrar TODO el historial?")) {
                if(confirm("‚ö†Ô∏è AVISO: Perder√°s todos los datos si no tienes una copia guardada. ¬øConfirmas el borrado definitivo?")) {
                    localStorage.removeItem('metalApp_v8_trabajos');
                    trabajos = [];
                    actualizarUI();
                }
            }
        }

        // Init
        actualizarUI();
    </script>
</body>
</html>